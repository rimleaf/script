--// Hitbox Extender Script (KRNL Safe, Local Only) //--

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Local stop flag (instead of getgenv)
local emergency_stop = false

-- Convert studs into power
local function StudsIntoPower(studs)
	return studs * 6
end

-- Clamp utility
local function Clamp(value, min, max)
	return math.max(min, math.min(max, value))
end

-- Main Extender
local function ExtendHitbox(studs, duration)
	local character = LocalPlayer.Character
	if not character then return end

	local humanoid = character:FindFirstChildOfClass("Humanoid")
	if not humanoid or humanoid.Health < 200 then
		-- Block extender if health < 200
		return
	end

	local hrp = character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	local distance = StudsIntoPower(studs)
	local startTime = tick()

	-- Reset stop flag if active
	if emergency_stop then
		emergency_stop = false
	end

	repeat
		RunService.Heartbeat:Wait()

		character = LocalPlayer.Character
		humanoid = character and character:FindFirstChildOfClass("Humanoid")
		hrp = character and character:FindFirstChild("HumanoidRootPart")

		if not (character and humanoid and hrp and hrp.Parent) then
			continue
		end

		local velocity = hrp.AssemblyLinearVelocity
		local lookVector = hrp.CFrame.LookVector

		local forwardSpeed = math.max(0, velocity:Dot(lookVector))
		local boost = forwardSpeed + distance

		-- Hardcoded clamp
		boost = Clamp(boost, 0, 50)

		hrp.AssemblyLinearVelocity = velocity + (lookVector * boost)

		RunService.RenderStepped:Wait()

		if character and hrp and hrp.Parent then
			hrp.AssemblyLinearVelocity = velocity
		end

	until tick() - startTime > tonumber(duration) or emergency_stop

	-- Reset after breaking loop
	if emergency_stop then
		emergency_stop = false
	end
end

-- Stop function
local function StopExtendingHitbox()
	emergency_stop = true
end

-- Auto-respawn reconnect
LocalPlayer.CharacterAdded:Connect(function(newChar)
	wait(0.5)
	StopExtendingHitbox()
	ExtendHitbox(2, 9e9)
end)
