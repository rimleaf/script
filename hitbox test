local lolz = {}

-- Ensure emergency_stop exists
if getgenv().emergency_stop == nil or not getgenv().emergency_stop then
    getgenv().emergency_stop = false
end

-- Converts studs into "power"
local function StudsIntoPower(studs)
    return studs * 10
end

-- Extend hitbox effect
function lolz:ExtendHitbox(studs, time)
    local distance = StudsIntoPower(studs)
    local start = tick()
    local connection = nil

    -- Reset emergency stop if it was active
    if getgenv().emergency_stop == true then
        getgenv().emergency_stop = false
    end

    repeat
        game:GetService("RunService").Heartbeat:Wait()

        -- Ensure character and HumanoidRootPart exist
        while not (
            game:GetService("Players").LocalPlayer.Character
            and game:GetService("Players").LocalPlayer.Character.Parent
            and game:GetService("Players").LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            and game:GetService("Players").LocalPlayer.Character.HumanoidRootPart.Parent
        ) do
            game:GetService("RunService").Heartbeat:Wait()
        end

        -- Save velocity before modifying
        local velocity = game:GetService("Players").LocalPlayer.Character.HumanoidRootPart.Velocity
        local lookvec = game:GetService("Players").LocalPlayer.Character.HumanoidRootPart.CFrame.LookVector

        -- Apply extended hitbox movement
        game:GetService("Players").LocalPlayer.Character.HumanoidRootPart.Velocity = (lookvec * distance)

        game:GetService("RunService").RenderStepped:Wait()

        -- Restore original velocity
        if (
            game:GetService("Players").LocalPlayer.Character
            and game:GetService("Players").LocalPlayer.Character.Parent
            and game:GetService("Players").LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            and game:GetService("Players").LocalPlayer.Character.HumanoidRootPart.Parent
        ) then
            game:GetService("Players").LocalPlayer.Character.HumanoidRootPart.Velocity = velocity
        end

    until tick() - start > tonumber(time) or getgenv().emergency_stop == true

    -- Reset emergency stop after finishing
    if getgenv().emergency_stop == true then
        getgenv().emergency_stop = false
    end
end

-- Force stop hitbox extension
function lolz:StopExtendingHitbox()
    getgenv().emergency_stop = true
end

return lolz
