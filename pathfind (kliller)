--// Services
local Players = game:GetService("Players")
local PathfindingService = game:GetService("PathfindingService")
local LocalPlayer = Players.LocalPlayer

--// Config
local followDistance = 0
local updateRate = 0.1 -- smoother path updates

--// GUI Setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FollowGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local followButton = Instance.new("TextButton")
followButton.Size = UDim2.new(0, 120, 0, 40)
followButton.Position = UDim2.new(0.05, 0, 0.2, 0)
followButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
followButton.TextColor3 = Color3.fromRGB(255, 255, 255)
followButton.Font = Enum.Font.SourceSansBold
followButton.TextSize = 20
followButton.Text = "Follow Nearest"
followButton.Parent = screenGui
followButton.Active = true
followButton.Draggable = true

--// Function: Get nearest player
local function getNearestPlayer(HRP)
	local nearest, nearestDist
	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			local dist = (plr.Character.HumanoidRootPart.Position - HRP.Position).Magnitude
			if not nearest or dist < nearestDist then
				nearest = plr
				nearestDist = dist
			end
		end
	end
	return nearest
end

--// Function: Follow player once
--// Function: Follow player continuously (always updates)
local function followPlayer(Character, Humanoid, HRP, target)
	while target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") do
		local targetHRP = target.Character.HumanoidRootPart
		local distance = (targetHRP.Position - HRP.Position).Magnitude

		if distance > followDistance then
			-- Make a new path every cycle
			local path = PathfindingService:CreatePath({
				AgentRadius = 2,
				AgentHeight = 5,
				AgentCanJump = true,
				AgentJumpHeight = 7,
				AgentMaxSlope = 45,
			})
			path:ComputeAsync(HRP.Position, targetHRP.Position)

			if path.Status == Enum.PathStatus.Success then
				local waypoints = path:GetWaypoints()
				if #waypoints > 0 then
					-- Only go to the next step, then recalc again
					Humanoid:MoveTo(waypoints[1].Position)
				end
			else
				-- fallback: direct MoveTo if path fails
				Humanoid:MoveTo(targetHRP.Position)
			end
		else
			return -- close enough, stop
		end

		task.wait(updateRate) -- recalc quickly
	end
end


--// Button Click
followButton.MouseButton1Click:Connect(function()
	if not LocalPlayer.Character then return end
	local Character = LocalPlayer.Character
	local Humanoid = Character:WaitForChild("Humanoid")
	local HRP = Character:WaitForChild("HumanoidRootPart")

	local nearest = getNearestPlayer(HRP)
	if nearest then
		followPlayer(Character, Humanoid, HRP, nearest)
	end
end)

--// Handle respawn
LocalPlayer.CharacterAdded:Connect(function(Character)
	Character:WaitForChild("Humanoid")
	Character:WaitForChild("HumanoidRootPart")
end)
