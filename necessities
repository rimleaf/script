-- Lead Hub (optimized + restored original Killer & Item ESP behavior)

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local lp = Players.LocalPlayer

-- Rayfield
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local Window = Rayfield:CreateWindow({
	Name = "Lead Hub",
	LoadingTitle = "Lead Hub",
	LoadingSubtitle = "by Lead",
	ConfigurationSaving = {Enabled = true, FolderName = "LeadHub", FileName = "Settings"},
	Discord = {Enabled = false},
	KeySystem = false
})

-- Tabs
local GeneratorTab = Window:CreateTab("Generators", 4483362458)
local ESPTab = Window:CreateTab("ESP", 4483362458)

--================= GENERATORS =================
local generatorCooldown = 2.5
local generatorLoop

local function GeneratorOnce()
	local IngameMapFolder = Workspace:FindFirstChild("Map") and Workspace.Map:FindFirstChild("Ingame")
	local SubMapFolder = IngameMapFolder and IngameMapFolder:FindFirstChild("Map")
	if SubMapFolder then
		for _, g in ipairs(SubMapFolder:GetChildren()) do
			if g.Name == "Generator" and g:FindFirstChild("Progress") and g.Progress.Value < 100 then
				task.wait(0.5)
				local remotes = g:FindFirstChild("Remotes")
				if remotes and remotes:FindFirstChild("RE") then
					pcall(function()
						remotes.RE:FireServer()
					end)
				end
			end
		end
	end
end

GeneratorTab:CreateToggle({
	Name = "Auto Generator",
	CurrentValue = false,
	Callback = function(enabled)
		if generatorLoop then generatorLoop:Disconnect() generatorLoop = nil end
		if enabled then
			local timer = 0
			generatorLoop = RunService.Heartbeat:Connect(function(dt)
				timer += dt
				if timer >= generatorCooldown then
					timer = 0
					GeneratorOnce()
				end
			end)
		end
	end
})

GeneratorTab:CreateSlider({
	Name = "Auto Generator Delay",
	Range = {1.5, 6},
	Increment = 0.1,
	Suffix = "s",
	CurrentValue = generatorCooldown,
	Callback = function(val)
		generatorCooldown = val
	end
})

--================= ESP =================
local espKillers = false
local espSurvivors = false
local espItems = false
local espGenerators = false

local activeHighlights = {}

local function findFirstBasePart(obj)
	if not obj or not obj:IsDescendantOf(Workspace) then return nil end
	if obj:IsA("BasePart") then return obj end
	return obj:FindFirstChildWhichIsA("BasePart", true)
end

local function addHighlight(obj, color, fillTrans, outlineTrans)
	if activeHighlights[obj] then return end
	local part = findFirstBasePart(obj)
	if not part then return end -- skip if model has no BasePart yet

	local h = Instance.new("Highlight")
	h.Name = "ESP_Highlight"
	h.Adornee = obj
	h.FillColor = color
	h.OutlineColor = Color3.new(0, 0, 0)
	h.FillTransparency = fillTrans
	h.OutlineTransparency = outlineTrans
	h.Parent = Workspace

	activeHighlights[obj] = h
end

local function removeHighlight(obj)
	local h = activeHighlights[obj]
	if h then
		h:Destroy()
		activeHighlights[obj] = nil
	end
	local billboard = obj:FindFirstChild("ESP_Billboard")
	if billboard then billboard:Destroy() end
end

local function applyItemESP(obj)
	if activeHighlights[obj] then return end
	local part = findFirstBasePart(obj)
	if not part then return end

	addHighlight(obj, Color3.fromRGB(0,0,139), 0.6, 0.6)

	if not obj:FindFirstChild("ESP_Billboard") then
		local billboard = Instance.new("BillboardGui")
		billboard.Name = "ESP_Billboard"
		billboard.Size = UDim2.new(0,100,0,30)
		billboard.StudsOffset = Vector3.new(0,3,0)
		billboard.AlwaysOnTop = true
		billboard.Adornee = part

		local textLabel = Instance.new("TextLabel")
		textLabel.Size = UDim2.new(1,0,1,0)
		textLabel.BackgroundTransparency = 1
		textLabel.TextColor3 = Color3.fromRGB(0,0,139)
		textLabel.Font = Enum.Font.SourceSansBold
		textLabel.TextSize = 14
		textLabel.Text = obj.Name
		textLabel.Parent = billboard

		billboard.Parent = obj
	end
end

local function refreshESP()
	local mapFolder = Workspace:FindFirstChild("Map") and Workspace.Map:FindFirstChild("Ingame") and Workspace.Map.Ingame:FindFirstChild("Map")

	-- Killers
	local killersFolder = Workspace:FindFirstChild("Players") and Workspace.Players:FindFirstChild("Killers")
	if killersFolder then
		for _, k in ipairs(killersFolder:GetChildren()) do
			if espKillers and k ~= Players.LocalPlayer.Character and findFirstBasePart(k) then
				addHighlight(k, Color3.fromRGB(255,0,0), 0.5, 0.3)
			else
				removeHighlight(k)
			end
		end
	end

	-- Survivors
	local survivorsFolder = Workspace:FindFirstChild("Players") and Workspace.Players:FindFirstChild("Survivors")
	if survivorsFolder then
		for _, s in ipairs(survivorsFolder:GetChildren()) do
			if espSurvivors and s ~= Players.LocalPlayer.Character and findFirstBasePart(s) then
				addHighlight(s, Color3.fromRGB(255,255,255), 0.5, 0.3)
			else
				removeHighlight(s)
			end
		end
	end

	-- Items and Generators
	if mapFolder then
		for _, obj in ipairs(mapFolder:GetChildren()) do
			if espItems and (obj.Name == "Medkit" or obj.Name == "BloxyCola") and findFirstBasePart(obj) then
				applyItemESP(obj)
			else
				if (obj.Name == "Medkit" or obj.Name == "BloxyCola") then removeHighlight(obj) end
			end

			if espGenerators and obj.Name == "Generator" and findFirstBasePart(obj) then
				local progress = obj:FindFirstChild("Progress")
				if progress and progress.Value < 100 then
					addHighlight(obj, Color3.fromRGB(255,255,0), 0.5, 0.3)
				else
					removeHighlight(obj)
				end
			elseif obj.Name == "Generator" then
				removeHighlight(obj)
			end
		end
	end
end

-- Background loop (every 2s instead of per-frame)
task.spawn(function()
	while task.wait(2) do
		if espKillers or espSurvivors or espItems or espGenerators then
			refreshESP()
		end
	end
end)

-- ESP Toggles
ESPTab:CreateToggle({
	Name = "Killers ESP",
	CurrentValue = false,
	Callback = function(val)
		espKillers = val
	end
})

ESPTab:CreateToggle({
	Name = "Survivors ESP",
	CurrentValue = false,
	Callback = function(val)
		espSurvivors = val
	end
})

ESPTab:CreateToggle({
	Name = "Items ESP",
	CurrentValue = false,
	Callback = function(val)
		espItems = val
	end
})

ESPTab:CreateToggle({
	Name = "Generators ESP",
	CurrentValue = false,
	Callback = function(val)
		espGenerators = val
	end
})

--================= CONFIG =================
Rayfield:LoadConfiguration()

print("[Lead Hub] Optimized ESP + Generators loaded.")
