-- Lead Hub (optimized + restored original Killer & Item ESP behavior)

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local lp = Players.LocalPlayer

-- Rayfield
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local Window = Rayfield:CreateWindow({
	Name = "Lead Hub",
	LoadingTitle = "Lead Hub",
	LoadingSubtitle = "by Lead",
	ConfigurationSaving = {Enabled = true, FolderName = "LeadHub", FileName = "Settings"},
	Discord = {Enabled = false},
	KeySystem = false
})

-- Tabs
local GeneratorTab = Window:CreateTab("Generators", 4483362458)
local ESPTab = Window:CreateTab("ESP", 4483362458)

--================= GENERATORS =================
local generatorCooldown = 2.5
local generatorLoop

local function GeneratorOnce()
	local IngameMapFolder = Workspace:FindFirstChild("Map") and Workspace.Map:FindFirstChild("Ingame")
	local SubMapFolder = IngameMapFolder and IngameMapFolder:FindFirstChild("Map")
	if SubMapFolder then
		for _, g in ipairs(SubMapFolder:GetChildren()) do
			if g.Name == "Generator" and g:FindFirstChild("Progress") and g.Progress.Value < 100 then
				task.wait(0.5)
				local remotes = g:FindFirstChild("Remotes")
				if remotes and remotes:FindFirstChild("RE") then
					pcall(function()
						remotes.RE:FireServer()
					end)
				end
			end
		end
	end
end

GeneratorTab:CreateToggle({
	Name = "Auto Generator",
	CurrentValue = false,
	Callback = function(enabled)
		if generatorLoop then generatorLoop:Disconnect() generatorLoop = nil end
		if enabled then
			local timer = 0
			generatorLoop = RunService.Heartbeat:Connect(function(dt)
				timer += dt
				if timer >= generatorCooldown then
					timer = 0
					GeneratorOnce()
				end
			end)
		end
	end
})

GeneratorTab:CreateSlider({
	Name = "Auto Generator Delay",
	Range = {1.5, 6},
	Increment = 0.1,
	Suffix = "s",
	CurrentValue = generatorCooldown,
	Callback = function(val)
		generatorCooldown = val
	end
})

--================= ESP =================
local espKillers = false
local espSurvivors = false
local espItems = false
local espGenerators = false

-- Utility: create or reuse highlight
local function getOrCreateHighlight(obj, color, fillTrans, outlineTrans)
	if not obj then return end
	local h = obj:FindFirstChild("ESP_Highlight")
	if not h then
		h = Instance.new("Highlight")
		h.Name = "ESP_Highlight"
		h.Adornee = obj
		h.Parent = obj
	end
	h.FillColor = color
	h.OutlineColor = Color3.new(0, 0, 0)
	h.FillTransparency = fillTrans
	h.OutlineTransparency = outlineTrans
	return h
end

-- Utility: clear highlight
local function clearESP(obj)
	if not obj then return end
	local h = obj:FindFirstChild("ESP_Highlight")
	if h then h:Destroy() end
	local b = obj:FindFirstChild("ESP_Billboard")
	if b then b:Destroy() end
end

-- Apply Item ESP
local function applyItemESP(obj)
	getOrCreateHighlight(obj, Color3.fromRGB(0,0,139), 0.6, 0.6)
	if not obj:FindFirstChild("ESP_Billboard") then
		local billboard = Instance.new("BillboardGui")
		billboard.Name = "ESP_Billboard"
		billboard.Size = UDim2.new(0,100,0,30)
		billboard.StudsOffset = Vector3.new(0,3,0)
		billboard.AlwaysOnTop = true
		billboard.Adornee = obj

		local textLabel = Instance.new("TextLabel")
		textLabel.Size = UDim2.new(1,0,1,0)
		textLabel.BackgroundTransparency = 1
		textLabel.TextColor3 = Color3.fromRGB(0,0,139)
		textLabel.Font = Enum.Font.SourceSansBold
		textLabel.TextSize = 14
		textLabel.Text = obj.Name
		textLabel.Parent = billboard

		billboard.Parent = obj
	end
end

-- ESP Loop (restored original logic)
task.spawn(function()
	while true do
		local mapFolder = Workspace:FindFirstChild("Map")
			and Workspace.Map:FindFirstChild("Ingame")
			and Workspace.Map.Ingame:FindFirstChild("Map")

		-- Killers ESP (constant loop refresh)
		if espKillers then
			local killers = Workspace:FindFirstChild("Players") and Workspace.Players:FindFirstChild("Killers")
			if killers then
				for _, k in ipairs(killers:GetChildren()) do
					getOrCreateHighlight(k, Color3.fromRGB(255,0,0), 0.5, 0.3)
				end
			end
		else
			local killers = Workspace:FindFirstChild("Players") and Workspace.Players:FindFirstChild("Killers")
			if killers then
				for _, k in ipairs(killers:GetChildren()) do clearESP(k) end
			end
		end

		-- Survivors ESP
		if espSurvivors then
			local survivors = Workspace:FindFirstChild("Players") and Workspace.Players:FindFirstChild("Survivors")
			if survivors then
				for _, s in ipairs(survivors:GetChildren()) do
					getOrCreateHighlight(s, Color3.fromRGB(255,255,255), 0.5, 0.3)
				end
			end
		else
			local survivors = Workspace:FindFirstChild("Players") and Workspace.Players:FindFirstChild("Survivors")
			if survivors then
				for _, s in ipairs(survivors:GetChildren()) do clearESP(s) end
			end
		end

		-- Items & Generators ESP
		if mapFolder then
			for _, obj in ipairs(mapFolder:GetChildren()) do
				if espItems and (obj.Name == "Medkit" or obj.Name == "BloxyCola") then
					applyItemESP(obj)
				elseif not espItems and (obj.Name == "Medkit" or obj.Name == "BloxyCola") then
					clearESP(obj)
				end

				if espGenerators and obj.Name == "Generator" then
					local progressVal = obj:FindFirstChild("Progress")
					if progressVal and progressVal.Value < 100 then
						getOrCreateHighlight(obj, Color3.fromRGB(255,255,0), 0.5, 0.3)
					else
						clearESP(obj)
					end
				elseif not espGenerators and obj.Name == "Generator" then
					clearESP(obj)
				end
			end
		end

		task.wait(1)
	end
end)

-- ESP Toggles
ESPTab:CreateToggle({
	Name = "Killers ESP",
	CurrentValue = false,
	Callback = function(val)
		espKillers = val
	end
})

ESPTab:CreateToggle({
	Name = "Survivors ESP",
	CurrentValue = false,
	Callback = function(val)
		espSurvivors = val
	end
})

ESPTab:CreateToggle({
	Name = "Items ESP",
	CurrentValue = false,
	Callback = function(val)
		espItems = val
	end
})

ESPTab:CreateToggle({
	Name = "Generators ESP",
	CurrentValue = false,
	Callback = function(val)
		espGenerators = val
	end
})

--================= CONFIG =================
Rayfield:LoadConfiguration()

print("[Lead Hub] Optimized ESP + Generators loaded.")
