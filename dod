-- DOD Lite – FINAL PH-OPTIMIZED (No Config Saving)

if getgenv then getgenv().hub_name = "DOD Lite" else _G.hub_name = "DOD Lite" end

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local temp_msg = Instance.new("Message", game.CoreGui)
temp_msg.Text = "Loading DOD Lite..."

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
temp_msg:Destroy()

local function Notify(t, c, time, success)
    pcall(function()
        Rayfield:Notify({Title=t, Content=c, Duration=time or 4, Image=success and 136186846844342 or 71508738660632})
    end)
end

local Config = {
    Stamina = {MaxStamina=105, WalkSpeed=17, SprintSpeed=26, NoLoss=false, NoFatigue=false},
    Visuals = {SurvivorESP={Enabled=false}, KillerESP={Enabled=false}},
}

local Character, Humanoid, HumanoidRootPart

local function UpdateCharacter()
    if not LocalPlayer.Character then return end
    Character = LocalPlayer.Character
    Humanoid = Character:FindFirstChild("Humanoid")
    HumanoidRootPart = Character:FindFirstChild("HumanoidRootPart")
end

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    UpdateCharacter()
end)
if LocalPlayer.Character then UpdateCharacter() end

local StaminaModule
pcall(function()
    StaminaModule = require(LocalPlayer.PlayerGui.MainGui.Client.Modules.Movement)
end)

local StaminaConn

local function ApplyStamina()
    if not Character or not Humanoid then return end
    pcall(function()
        Character:SetAttribute("MaxStamina", Config.Stamina.MaxStamina)
        Character:SetAttribute("SprintSpeed", Config.Stamina.SprintSpeed)
        Humanoid.WalkSpeed = Config.Stamina.WalkSpeed
    end)
    if Config.Stamina.NoLoss and StaminaModule then
        StaminaModule.Stamina = Config.Stamina.MaxStamina
    end
    if Config.Stamina.NoFatigue then
        Character:SetAttribute("Fatigue", 0)
    end
end

local function StartStaminaLoop()
    if StaminaConn then StaminaConn:Disconnect() end
    StaminaConn = RunService.RenderStepped:Connect(ApplyStamina)
end

StartStaminaLoop()
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    UpdateCharacter()
    StartStaminaLoop()
end)

local ESPHighlights = {}
local ESPConnections = {}

local function CleanupESP(p)
    if ESPHighlights[p] then pcall(function() ESPHighlights[p]:Destroy() end); ESPHighlights[p] = nil end
    if ESPConnections[p] then
        for _, c in pairs(ESPConnections[p]) do if c and c.Connected then c:Disconnect() end end
        ESPConnections[p] = nil
    end
end

local function UpdateESP(p)
    local h = ESPHighlights[p]
    if not h or not h.Parent then return end

    local char = p.Character
    if not char or not char.Parent or not char:FindFirstChild("Humanoid") or char.Humanoid.Health <= 0 then
        CleanupESP(p)
        return
    end

    local success, result = pcall(function()
        return Workspace.GameAssets.Teams.Killer:FindFirstChild(p.Name) ~= nil
    end)
    
    local isKiller = false
    if success and result then
        isKiller = true
    end

    local enabled = false

    if isKiller and Config.Visuals.KillerESP.Enabled then
        h.FillColor = Color3.fromRGB(255,0,0) -- Killer red
        enabled = true
    elseif not isKiller and Config.Visuals.SurvivorESP.Enabled then
        h.FillColor = Color3.fromRGB(0,255,0) -- Survivor green
        enabled = true
    end

    h.Enabled = enabled
end


local function ApplyESP(p)
    if p == LocalPlayer or not p.Character then return end
    CleanupESP(p)
    local h = Instance.new("Highlight")
    h.Name = "DOD_ESP"
    h.Parent = p.Character
    h.Adornee = p.Character
    h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    h.FillTransparency = 0.5
    h.OutlineTransparency = 0
    h.OutlineColor = Color3.fromRGB(255,255,255)
    h.Enabled = false
    ESPHighlights[p] = h
    ESPConnections[p] = { RunService.Heartbeat:Connect(function() UpdateESP(p) end) }
end

for _, p in Players:GetPlayers() do
    if p.Character then task.spawn(ApplyESP, p) end
    p.CharacterAdded:Connect(function() task.wait(0.5); ApplyESP(p) end)
end
Players.PlayerAdded:Connect(function(p)
    p.CharacterAdded:Connect(function() task.wait(0.5); ApplyESP(p) end)
end)
Players.PlayerRemoving:Connect(CleanupESP)

local AbilityNames = {"Cloak","Punch","Taunt","BonusPad","Block","Caretaker","Dash","Hotdog","Revolver","Adrenaline","Banana"}
local AbilityDatas = {
    ["Adrenaline"] = {Name="Adrenaline",Tip="Speed boost...",Cooldown=35,Icon="rbxassetid://116399911657417",DisplayName="Adrenaline"},
    ["Punch"] = {Name="Punch",Tip="Stun killer...",Cooldown=40,Icon="rbxassetid://97428323453639",DisplayName="Punch"},
    ["Caretaker"] = {Name="Caretaker",Tip="Heal team...",Cooldown=30,Icon="rbxassetid://90712805517714",DisplayName="Caretaker"},
    ["Cloak"] = {Name="Cloak",Tip="Go invisible...",Cooldown=50,Icon="rbxassetid://90476367580326",DisplayName="Cloak"},
    ["Block"] = {Name="Block",Tip="Block damage...",Cooldown=40,Icon="rbxassetid://120929805037270",DisplayName="Block"},
    ["Dash"] = {Name="Dash",Tip="Dash forward...",Cooldown=20,Icon="rbxassetid://73777691791017",DisplayName="Dash"},
    ["BonusPad"] = {Name="BonusPad",Tip="Speed pad...",Cooldown=70,Icon="rbxassetid://86775625332300",DisplayName="BonusPad"},
    ["Hotdog"] = {Name="Hotdog",Tip="Heal 15 HP...",Cooldown=15,Icon="rbxassetid://134322360499381",DisplayName="Hotdog"},
    ["Revolver"] = {Name="Revolver",Tip="Stun shot...",Cooldown=15,Icon="rbxassetid://107624957891469",DisplayName="Revolver"},
    ["Taunt"] = {Name="Taunt",Tip="Slow killer...",Cooldown=25,Icon="rbxassetid://85436299122876",DisplayName="Taunt"},
    ["Banana"] = {Name="Banana",Tip="Slip killer...",Cooldown=20,Icon="rbxassetid://96202444819611",DisplayName="Banana Peel"},
}

local AbilityTemplate = LocalPlayer.PlayerGui:WaitForChild("MainGui").Client.Modules.Ability.AbilityTemplate

local function CreateAbility(data)
    if LocalPlayer.PlayerGui.MainGui.Abilities.Folder:FindFirstChild(data.Name) then return end
    local btn = AbilityTemplate:Clone()
    btn.Parent = LocalPlayer.PlayerGui.MainGui.Abilities.Folder
    btn.Name = data.Name
    btn.Title.Text = data.DisplayName
    btn.Icon.Image = data.Icon
    btn.Input.Text = data.InputShown or "Q"
    btn.MouseEnter:Connect(function()
        local tip = LocalPlayer.PlayerGui.MainGui.Abilities.Tip
        tip.Label.Text = "<font color='rgb(137,255,26)'>Usage:</font> <font color='rgb(255,255,255)'>"..(data.Tip or "").."</font>"
        tip.Visible = true
    end)
    btn.MouseLeave:Connect(function() LocalPlayer.PlayerGui.MainGui.Abilities.Tip.Visible = false end)
    btn.Activated:Connect(function()
        pcall(function()
            ReplicatedStorage.Events.RemoteFunctions.UseAbility:InvokeServer(data.Name)
        end)
    end)
end

local Window = Rayfield:CreateWindow({
    Name = "DOD Lite",
    LoadingTitle = "DOD Lite",
    LoadingSubtitle = "Stamina • ESP • Abilities",
    ConfigurationSaving = { Enabled = false },
    KeySystem = false
})

local StaminaTab = Window:CreateTab("Stamina", 0)

StaminaTab:CreateToggle({
    Name = "No Stamina Loss",
    CurrentValue = Config.Stamina.NoLoss,
    Callback = function(v) Config.Stamina.NoLoss = v end
})

StaminaTab:CreateToggle({
    Name = "No Fatigue",
    CurrentValue = Config.Stamina.NoFatigue,
    Callback = function(v) Config.Stamina.NoFatigue = v end
})

StaminaTab:CreateInput({
    Name = "Max Stamina", PlaceholderText = "100", NumbersOnly = true,
    Callback = function(v) Config.Stamina.MaxStamina = tonumber(v) or 100 end
})

StaminaTab:CreateInput({
    Name = "Walk Speed", PlaceholderText = "16", NumbersOnly = true,
    Callback = function(v) Config.Stamina.WalkSpeed = tonumber(v) or 16 end
})

StaminaTab:CreateInput({
    Name = "Sprint Speed", PlaceholderText = "25", NumbersOnly = true,
    Callback = function(v) Config.Stamina.SprintSpeed = tonumber(v) or 25 end
})

local ESPTab = Window:CreateTab("ESP", 0)

ESPTab:CreateToggle({
    Name = "Survivor ESP",
    CurrentValue = Config.Visuals.SurvivorESP.Enabled,
    Callback = function(v) Config.Visuals.SurvivorESP.Enabled = v end
})

ESPTab:CreateToggle({
    Name = "Killer ESP",
    CurrentValue = Config.Visuals.KillerESP.Enabled,
    Callback = function(v) Config.Visuals.KillerESP.Enabled = v end
})

ESPTab:CreateButton({
    Name = "Refresh ESP",
    Callback = function()
        for _, p in Players:GetPlayers() do
            CleanupESP(p)
            if p.Character then ApplyESP(p) end
        end
        Notify("ESP Refreshed", "", 2, true)
    end
})

local AbilitiesTab = Window:CreateTab("Abilities", 0)

local Keybind = "E"
AbilitiesTab:CreateKeybind({Name="Keybind", CurrentKeybind="E", Callback=function(v) Keybind = v end})

local ChosenAbility = "Block"
AbilitiesTab:CreateDropdown({Name="Choose Ability", Options=AbilityNames, CurrentOption="Block", Callback=function(v) ChosenAbility = v[1] or v end})

AbilitiesTab:CreateButton({Name="Get Ability", Callback=function()
    local d = table.clone(AbilityDatas[ChosenAbility])
    d.InputShown = Keybind.Name or tostring(Keybind)
    CreateAbility(d)
end})

AbilitiesTab:CreateButton({Name="Get All Abilities", Callback=function()
    for _, name in ipairs(AbilityNames) do
        local d = table.clone(AbilityDatas[name])
        d.InputShown = Keybind.Name or tostring(Keybind)
        CreateAbility(d)
    end
end})

local SpamAbility = "Hotdog"
AbilitiesTab:CreateDropdown({Name="Spam Ability", Options=AbilityNames, CurrentOption="Hotdog", Callback=function(v) SpamAbility = v[1] end})

local AutoSpam = false
AbilitiesTab:CreateToggle({Name="Enable Spam", Callback=function(v)
    AutoSpam = v
    if v then task.spawn(function()
        local rf = ReplicatedStorage.Events.RemoteFunctions.UseAbility
        while AutoSpam do
            pcall(function() rf:InvokeServer(SpamAbility) end)
            task.wait(0.1)
        end
    end) end
end})

local AI1, AI2, AutoInject = "", "", false
AbilitiesTab:CreateSection("Auto Inject (Round Start)")
AbilitiesTab:CreateToggle({Name="Auto Inject", Callback=function(v) AutoInject = v end})
AbilitiesTab:CreateDropdown({Name="Ability 1", Options=AbilityNames, Callback=function(v) AI1 = v[1] end})
AbilitiesTab:CreateDropdown({Name="Ability 2", Options=AbilityNames, Callback=function(v) AI2 = v[1] end})

Workspace.GameAssets.Teams.DescendantAdded:Connect(function(child)
    if child.Name == LocalPlayer.Name and child.Parent.Name == "Survivor" and AutoInject then
        task.wait(8)
        local ev = ReplicatedStorage.Events.RemoteEvents.AbilitySelection
        pcall(function() if AI1 ~= "" then ev:FireServer(AI1) end end)
        pcall(function() if AI2 ~= "" then ev:FireServer(AI2) end end)
    end
end)

Notify("DOD Lite Loaded", "Config removed, running clean.", 5, true)
